# Code Review — Stories 10-1, 10-3, 10-4, 14-1, 14-1b

**Date:** 2026-02-13  
**Workflow:** Adversarial Code Review  
**Stories:** 10-1 (Home), 10-3 (Leagues), 10-4 (Join), 14-1 (Design Tokens), 14-1b (Design System Showcase)

---

## Git vs Story Discrepancies

**Modified files (git status):** Many files modified across design system, pages, components. Stories 10-1, 10-3, 10-4, 14-1, 14-1b have had multiple prior reviews. Current uncommitted changes include SegmentedTabs (14-30), Tournaments (variant encapsulated), TournamentCard, LeagueCard, DesignSystemShowcase, etc.

**Note:** Excluded \_bmad/, \_bmad-output/, .cursor/ from review scope per workflow instructions.

---

## Findings Summary

| Story | Critical | High | Medium | Low |
| ----- | -------- | ---- | ------ | --- |
| 10-1  | 0        | 0    | 0      | 1   |
| 10-3  | 0        | 1    | 1      | 0   |
| 10-4  | 0        | 0    | 0      | 0   |
| 14-1  | 0        | 1    | 0      | 0   |
| 14-1b | 0        | 0    | 0      | 1   |

---

## CRITICAL ISSUES

_Aucun_

---

## HIGH ISSUES

### [10-3] Leagues: PaymentModal onSuccess ne rafraîchit pas le statut premium

**Fichier:** `src/pages/Leagues.tsx` (lignes 130, 205)  
**Problème:** `onSuccess={() => reloadData()}` rafraîchit uniquement les leagues. `usePremiumLimits` lit `user?.user_metadata?.isPremium` depuis AuthContext. Après un upgrade Premium, le statut premium n’est pas rafraîchi — l’utilisateur reste bloqué sur « limite atteinte » jusqu’à rechargement de la page.

**Comparaison:** Home.tsx passe `handlePaymentSuccess` avec `refetchPremium()` et `invalidateQueries`. Leagues ne rafraîchit pas le statut premium.

**Recommandation:** Utiliser `usePremium` et appeler `refetchPremium()` dans onSuccess, ou invalider la source utilisée par usePremiumLimits. Alternative : centraliser le rafraîchissement dans PaymentModal.

---

### [14-1] Test tailwind-design-tokens : gradient-card échoue

**Fichier:** `tests/unit/config/tailwind-design-tokens.test.ts` (ligne 43-47)  
**Problème:** Le test attend `"linear-gradient(to right, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98))"` (Story 14-29, design-system-convergence 3.2). La config actuelle a `"linear-gradient(to left, rgba(51, 65, 85, 0.98), rgba(30, 41, 59, 0.98))"` — direction et couleurs différentes.

**Impact:** 1 test en échec dans la suite.

**Recommandation:** Aligner `tailwind.config.js` sur la spec 14-29 (to right, slate-800→slate-900) OU adapter le test si la valeur actuelle est intentionnelle.

---

## MEDIUM ISSUES

### [10-3] Tournaments: PaymentModal sans onSuccess

**Fichier:** `src/pages/Tournaments.tsx` (lignes 127-131, 195-199)  
**Problème:** PaymentModal n’a pas de prop `onSuccess`. Après un upgrade Premium (limite tournois atteinte), la page ne se met pas à jour.

**Recommandation:** Ajouter `onSuccess` comme sur Home et Leagues (refetch premium + invalidate homeData si pertinent).

---

## LOW ISSUES

### [10-1] Home: AC1 header — "Dernier Tournoi" vs "Mon dernier tournoi"

**Fichier:** `src/pages/Home.tsx` (lignes 99, 105)  
**Problème:** AC1 mentionne les sections "Dernier Tournoi" et "Dernière League". L’implémentation utilise "Mon dernier tournoi" et "Ma dernière league". Léger écart de libellé.

**Recommandation:** Harmoniser avec la spec ou valider le choix UX.

---

### [14-1b] DesignSystemShowcase: Import HelpCard non documenté

**Fichier:** `src/pages/DesignSystemShowcase.tsx` (ligne 15)  
**Problème:** Import de `HelpCard` alors que le File List de la story 14-1b ne le mentionne pas. HelpCard semble ajouté hors scope de la story.

**Recommandation:** Documenter dans le File List ou retirer si hors scope.

---

## Stories sans problème bloquant

- **10-4 (Join):** Implémentation solide, CodeInputModal gère correctement les erreurs, tests passants.
- **14-1:** Tokens bien structurés, seul le test gradient-card pose problème.

---

## Corrections appliquées (automatiques)

### HIGH

- **[10-3] Leagues PaymentModal** — usePremiumLimits utilise désormais usePremium (premiumService) pour isPremium. Ajout de refetchPremium dans le retour. handlePaymentSuccess appelle refetchPremium() + reloadData().
- **[14-1] gradient-card** — tailwind.config.js aligné sur la spec 14-29 : `linear-gradient(to right, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98))`.

### MEDIUM

- **[10-3] Tournaments PaymentModal** — Ajout de onSuccess avec handlePaymentSuccess (refetchPremium + reloadData). Mock useLeague dans les tests.

### Fichiers modifiés

- `src/hooks/usePremiumLimits.ts` — Utilise usePremium, expose refetchPremium
- `src/pages/Leagues.tsx` — handlePaymentSuccess
- `src/pages/Tournaments.tsx` — handlePaymentSuccess, useLeague
- `tailwind.config.js` — gradient-card
- `tests/unit/pages/Tournaments.test.tsx` — Mock useLeague, refetchPremium
- `tests/unit/pages/Leagues.test.tsx` — refetchPremium dans les mocks
- `tests/unit/pages/Home.refactored.test.tsx` — refetchPremium dans le mock
- `tests/unit/hooks/usePremiumLimits.test.ts` — Mock usePremium

---

## Prochaines étapes

1. **Corriger automatiquement** — ✅ Appliqué
2. **Créer des action items** — Les items LOW restent en attente (AC1 libellés, HelpCard doc)
3. **Détails** — Approfondir un point spécifique
