# Code Review ‚Äî Stories 10-1, 10-3, 10-4, 14-1

**Date:** 2026-02-13  
**Reviewer:** Adversarial Senior Developer (Code Review Workflow)  
**Stories:** 10-1 (Home), 10-3 (Leagues), 10-4 (Join), 14-1 (Design Tokens)

---

## Executive Summary

| Story | High | Medium | Low | Total |
|-------|------|--------|-----|-------|
| 10-1  | 1    | 2      | 2   | 5     |
| 10-3  | 0    | 2      | 2   | 4     |
| 10-4  | 0    | 2      | 2   | 4     |
| 14-1  | 0    | 1      | 2   | 3     |

**Git vs Story:** No critical discrepancies. All File Lists align with implementation.

---

## Story 10-1: Home Page (Connected User Dashboard)

### HIGH

1. **[AC6 Violation] max-width 1200px non respect√©**
   - **AC6:** "apply max-width 1200px, centered"
   - **Impl√©mentation:** `max-w-7xl` (1280px) dans Home.tsx:58
   - **Fichier:** `src/pages/Home.tsx:58`
   - **Fix:** Remplacer par `max-w-[1200px]` ou `max-w-7xl` ‚Üí `max-w-[1200px]`

### MEDIUM

2. **[Incoh√©rence] Headers de section vs AC1**
   - **AC1:** "Dernier Tournoi", "Derni√®re League", "Mes Stats"
   - **Impl√©mentation:** "Mon dernier tournoi", "Ma derni√®re league" (Home.tsx:80, 86)
   - **Fichier:** `src/pages/Home.tsx`
   - **Note:** Peut √™tre intentionnel (ton plus personnel). √Ä valider avec le product owner.

3. **[Type safety] Non-null assertion risqu√©e**
   - **Fichier:** `src/hooks/useHomeData.ts:204`
   - **Code:** `queryFn: () => fetchHomeData(userId!)`
   - **Probl√®me:** Si `enabled` et `queryFn` ne sont pas parfaitement synchronis√©s, `userId` pourrait √™tre null au moment de l'appel.
   - **Fix:** Utiliser une closure ou v√©rifier `userId` dans le queryFn avant d'appeler fetchHomeData.

### LOW

4. **[UX] Gestion d'erreur brutale**
   - **Fichier:** `src/pages/Home.tsx:41-46`
   - **Code:** `window.location.reload()` sur erreur
   - **Probl√®me:** Rechargement complet de la page au lieu d'un refetch React Query.
   - **Suggestion:** Utiliser `refetch()` de useQuery pour une meilleure UX.

5. **[Coh√©rence] useAuth vs useAuthContext**
   - **Fichier:** `src/pages/Home.tsx:2, 14`
   - **Probl√®me:** Home utilise `useAuth()` alors que la plupart des composants utilisent `useAuthContext()`.
   - **Note:** Les deux fonctionnent (AuthContext wrap useAuth). Coh√©rence du codebase.

---

## Story 10-3: Leagues List Page

### MEDIUM

1. **[AC5 Partiel] Message modal premium league non personnalis√©**
   - **AC5:** "show premium modal: 'Version gratuite limit√©e √† 1 league active'"
   - **Impl√©mentation:** PaymentModal g√©n√©rique sans message personnalis√© pour la limite league.
   - **Fichier:** `src/pages/Leagues.tsx`, `src/components/PaymentModal.tsx`
   - **Fix:** Passer un prop `customMessage` ou `limitType="league"` √† PaymentModal pour afficher le message AC5.

2. **[Error handling] useLeaguesList ne remonte pas les erreurs**
   - **Fichier:** `src/hooks/useLeaguesList.ts`
   - **Probl√®me:** Le hook ne retourne pas `error`. Si LeagueContext √©choue, l'utilisateur reste en loading ind√©finiment.
   - **Fix:** Exposer `error` depuis LeagueContext et le propager dans useLeaguesList.

### LOW

3. **[Design tokens] Couleurs hardcod√©es**
   - **Fichier:** `src/components/leagues/LeagueCard.tsx:65-66`
   - **Code:** `bg-green-500/20 text-green-400` pour le badge Active
   - **Suggestion:** Utiliser `bg-status-active/20 text-status-active` ou tokens design system (Story 14-1).

4. **[Documentation] File List incomplet**
   - Le LoadingSpinner a √©t√© modifi√© (data-testid) pour les tests Leagues mais n'est pas list√© dans la story 10-3 File List.
   - **Note:** D√©j√† document√© dans la review pr√©c√©dente.

---

## Story 10-4: Join Page (QR Scanner & Code Input)

### MEDIUM

1. **[AC3/AC4] Erreur non affich√©e dans le modal**
   - **AC3/AC4:** "show error if invalid"
   - **Impl√©mentation:** Les erreurs sont affich√©es uniquement via toast. Le CodeInputModal a un state `error` mais ne le re√ßoit jamais du parent.
   - **Fichier:** `src/components/join/CodeInputModal.tsx`, `src/pages/Join.tsx`
   - **Fix:** Passer l'erreur du hook au modal (ex: prop `error` ou callback qui retourne l'erreur) pour affichage inline.

2. **[AC1] Labels bottom menu sans emojis**
   - **AC1:** "üì∑ SCANNER QR" | "üî¢ CODE"
   - **Impl√©mentation:** "SCANNER QR" et "CODE" avec ic√¥nes Lucide (Camera, Hash).
   - **Note:** Les ic√¥nes remplacent les emojis. Acceptable mais √©cart par rapport √† la spec litt√©rale.
   - **Fichier:** `src/pages/Join.tsx:116-126`

### LOW

3. **[Performance] Timeout Promise.race sans annulation**
   - **Fichier:** `src/hooks/useJoinTournament.ts:43-56`
   - **Probl√®me:** `Promise.race` avec timeout de 10s. Si le timeout gagne, la requ√™te Supabase continue en arri√®re-plan (pas d'AbortController).
   - **Suggestion:** Utiliser AbortController pour annuler la requ√™te si timeout.

4. **[Accessibilit√©] CodeInputModal focus trap**
   - Le modal n'a pas de focus trap. L'utilisateur peut tabber en dehors du modal.
   - **Suggestion:** Ajouter un focus trap pour les modales (pattern standard a11y).

---

## Story 14-1: Design Tokens

### MEDIUM

1. **[Parit√© CSS] Gradients manquants dans design-tokens.css**
   - **Fichier:** `src/styles/design-tokens.css`
   - **Probl√®me:** `gradient-cta-alt` et `gradient-tab-active` sont dans tailwind.config.js mais pas dans design-tokens.css.
   - **Fix:** Ajouter `--gradient-cta-alt` et `--gradient-tab-active` pour parit√© compl√®te.

### LOW

2. **[Documentation] Usage des tokens non document√©**
   - Aucun composant n'utilise encore les tokens (bg-background-primary, etc.).
   - **D√©j√† not√©** dans la review pr√©c√©dente. Migration progressive pr√©vue.
   - **Suggestion:** Ajouter une section dans Dev Notes ou README design-tokens.

3. **[Tests] Pas de validation CSS r√©elle**
   - Les tests v√©rifient la structure du config Tailwind, pas les styles calcul√©s dans le DOM.
   - **D√©j√† not√©** dans la review pr√©c√©dence. Optionnel.

---

## Recommandations

1. **Priorit√© 1:** Corriger AC6 Home (max-width 1200px)
2. **Priorit√© 2:** Personnaliser PaymentModal pour limite league (AC5 10-3)
3. **Priorit√© 3:** Afficher l'erreur inline dans CodeInputModal (10-4)
4. **Priorit√© 4:** Ajouter gradients manquants dans design-tokens.css (14-1)

---

## Corrections appliqu√©es (2026-02-13)

**Option 1 (Fix automatique) ex√©cut√©e.**

### 10-1 (Home)
- ‚úÖ max-width 1200px : `max-w-7xl` ‚Üí `max-w-[1200px]` (Home.tsx)
- ‚úÖ useHomeData userId : guard `if (!userId) throw` dans queryFn (useHomeData.ts)

### 10-3 (Leagues)
- ‚úÖ PaymentModal : props title/subtitle ajout√©s pour message limite league (AC5)
- ‚úÖ Leagues.tsx : passe title et subtitle quand isAtLeagueLimit
- ‚è≠Ô∏è useLeaguesList error : non modifi√© (n√©cessite refactor LeagueContext ‚Äî scope)

### 10-4 (Join)
- ‚úÖ CodeInputModal error inline : handleJoinByCode re-throw pour que le modal affiche l'erreur
- ‚úÖ Bottom menu AC1 : labels "üì∑ SCANNER QR" et "üî¢ CODE"

### 14-1 (Design Tokens)
- ‚úÖ design-tokens.css : gradient-cta-alt et gradient-tab-active d√©j√† pr√©sents (fix pr√©c√©dent)
- ‚úÖ design-tokens.css : doc migration progressive (Usage Tailwind vs variables CSS)

### Corrections additionnelles (session 2026-02-13)
- ‚úÖ usePremium : ajout `refetch()` pour rafra√Æchir le statut premium sans reload
- ‚úÖ Home handlePaymentSuccess : `refetchPremium()` remplace `window.location.reload()`
- ‚úÖ Tournaments : max-w-6xl ‚Üí max-w-[1200px] (alignement AC)
- ‚úÖ useHomeData : garde `if (!userId)` au d√©but de fetchHomeData
- ‚úÖ Tests Home : mock refetch pour usePremium
- ‚úÖ Tests useHomeData : mock maybeSingle + elo_history pour "zero matches"

## Prochaines √©tapes

Choisir une option :

1. **Corriger automatiquement** ‚Äî Appliquer les correctifs HIGH et MEDIUM
2. **Cr√©er des action items** ‚Äî Ajouter dans Tasks/Subtasks des stories concern√©es
3. **D√©tails** ‚Äî Approfondir un point sp√©cifique
