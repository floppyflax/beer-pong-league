# Code Review — Batch 10-1, 10-3, 10-4, 14-1, 14-1b

**Date:** 2026-02-13  
**Reviewer:** Adversarial Code Review Workflow  
**Stories:** 10-1 (Home), 10-3 (Leagues), 10-4 (Join), 14-1 (Design tokens), 14-1b (Design System Showcase)

---

## Git vs Story Discrepancies

**Fichiers modifiés (git) non listés dans les stories de ce batch:**
- Fichiers liés aux stories 14-15, 14-14, 14-29, 14-30, 14-31, 14-32 — hors périmètre.

**Note:** Les stories 10-1, 10-3, 10-4, 14-1, 14-1b sont marquées `done` dans sprint-status.yaml.

---

## Issues Found

### CRITICAL

#### 1. [10-1] AC1 — Salut [Username] : utilisateurs anonymes affichent "Champion"

**Severity:** CRITICAL  
**File:** `src/pages/Home.tsx:81`

**Issue:** AC1 exige "Salut [Username]". Le code utilise `user?.email?.split('@')[0] || 'Champion'`. Pour les utilisateurs anonymes (`user` null), le fallback "Champion" s'affiche. Pour les utilisateurs authentifiés sans email (OTP), le même fallback s'applique. Le nom d'affichage de l'identité locale (`localUser?.displayName`) n'est jamais utilisé.

**Evidence:** `const userId = user?.id ?? localUser?.anonymousUserId ?? null` — l'app gère les anonymes sur la Home, mais le greeting ignore `localUser`.

**Fix:** Utiliser `localUser?.displayName ?? user?.email?.split('@')[0] ?? 'Champion'` pour respecter l'identité locale et AC1.

---

#### 2. [10-4] CodeInputModal — isLoading jamais réinitialisé en cas de succès

**Severity:** CRITICAL  
**File:** `src/components/join/CodeInputModal.tsx:35-41`

**Issue:** En cas de succès, `await onSubmit(code)` déclenche la navigation et le parent ferme la modal. `setIsLoading(false)` n'est jamais appelé (seul le `catch` le fait). Si la navigation est lente ou différée, le bouton reste en état "VÉRIFICATION..." indéfiniment. Risque de boucle visuelle si l'utilisateur rouvre la modal.

**Evidence:**
```typescript
try {
  await onSubmit(code);
  // Success - modal will be closed by parent after navigation
} catch (err) {
  setError(message);
  setIsLoading(false);
}
```

**Fix:** Ajouter `setIsLoading(false)` dans le bloc `try` après `await onSubmit(code)`, ou utiliser `finally { setIsLoading(false); }` pour couvrir tous les chemins.

---

### HIGH

#### 3. [14-1] design-tokens.css — gradient-card manquant

**Severity:** HIGH  
**Files:** `src/styles/design-tokens.css`, `tailwind.config.js:41-42`

**Issue:** `tailwind.config.js` définit `gradient-card` (Story 14-29) mais `design-tokens.css` ne l'inclut pas. Les autres gradients (gradient-cta, gradient-fab, etc.) ont une variable CSS correspondante. Parité rompue entre Tailwind et CSS variables.

**Fix:** Ajouter `--gradient-card: linear-gradient(to right, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98));` dans `:root` de design-tokens.css.

---

#### 4. [10-1] useHomeData — pas de vérification isSupabaseAvailable()

**Severity:** HIGH  
**File:** `src/hooks/useHomeData.ts:44-50`

**Issue:** project-context.md exige "Always check isSupabaseAvailable() before operations". Le hook vérifie `if (!supabase)` mais pas `isSupabaseAvailable()`. DatabaseService et PremiumService utilisent une méthode dédiée. Comportement potentiellement différent si Supabase est configuré mais indisponible (réseau, etc.).

**Fix:** Vérifier si une fonction globale `isSupabaseAvailable()` existe ; sinon, documenter que `!supabase` est le garde-fou actuel et aligner le project-context.

---

#### 5. [10-4] extractCodeFromQR — codes invalides possibles

**Severity:** HIGH  
**File:** `src/utils/extractCodeFromQR.ts:18-28`

**Issue:** Pour des URLs comme `https://example.com/tournament/123/join` (sans param `code`), `lastSegment` = "join" ne matche pas le regex 6-8 chars. Le fallback `return qrData.toUpperCase().trim()` renvoie "JOIN" (4 caractères). useJoinTournament rejette ensuite, mais l'UX est dégradée : l'utilisateur voit "Code invalide" au lieu d'un message plus explicite ("QR invalide, saisissez le code manuellement").

**Fix:** Si aucun code valide n'est extrait, retourner une chaîne vide ou lever une erreur spécifique pour permettre un message utilisateur adapté.

---

### MEDIUM

#### 6. [10-1] useAuth vs useAuthContext — incohérence

**Severity:** MEDIUM  
**File:** `src/pages/Home.tsx:4,19`

**Issue:** Home utilise `useAuth()` alors que le reste de l'app (TournamentDashboard, LeagueCard, PaymentModal, etc.) utilise `useAuthContext()`. AuthContext encapsule useAuth, le comportement est équivalent mais le pattern est incohérent.

**Fix:** Remplacer `useAuth` par `useAuthContext` dans Home pour cohérence.

---

#### 7. [10-3] AC1 — Bottom menu vs FAB

**Severity:** MEDIUM  
**File:** `src/pages/Leagues.tsx`

**Issue:** AC1 exige "Bottom menu with CRÉER button (mobile)". L'implémentation utilise un FAB (`<FAB icon={Plus} ... />`) et non BottomMenuSpecific. Story 14-16 a migré /leagues vers FAB, mais la story 10-3 n'a pas été mise à jour. Écart entre spec et implémentation.

**Fix:** Mettre à jour la story 10-3 pour refléter l'usage du FAB, ou documenter la décision de design (Story 14-16).

---

#### 8. [10-3] useLeaguesList — onglet "Terminés" toujours vide

**Severity:** MEDIUM  
**File:** `src/hooks/useLeaguesList.ts:46`

**Issue:** Toutes les leagues sont en `status: 'active'` (table sans colonne status). L'onglet "Terminés" ne renvoie jamais de résultat. L'utilisateur peut croire à un bug.

**Fix:** Désactiver ou masquer l'onglet "Terminés" tant que la migration DB n'est pas faite, ou afficher un message "Bientôt disponible".

---

#### 9. [14-1b] navigationHelpers — design-system exclu mais pas design-system/*

**Severity:** MEDIUM  
**File:** `src/utils/navigationHelpers.ts:38`

**Issue:** `EXCLUDED_PATTERNS` contient `/^\/design-system$/` (match exact). Une route `/design-system/tokens` ou `/design-system/components` afficherait la bottom nav. AC7 exige "bottom nav hidden on this page" — interprétation stricte = toute la section design-system.

**Fix:** Utiliser `/^\/design-system/` pour exclure tous les sous-chemins.

---

### LOW

#### 10. [10-1] useHomeData — console.error en production

**Severity:** LOW  
**File:** `src/hooks/useHomeData.ts:200`

**Issue:** `console.error('Error fetching home data:', error)` reste actif en production. project-context indique "Never use console.error() only" et prévoit Sentry. Le TODO Sentry est présent mais non implémenté.

**Fix:** Conditionner le log à `import.meta.env.DEV` ou l'intégrer à Sentry dès que disponible.

---

#### 11. [10-4] useJoinTournament — double toast en erreur

**Severity:** LOW  
**File:** `src/hooks/useJoinTournament.ts:80-84`

**Issue:** En cas d'erreur : `setError(errorMessage)` + `toast.error(errorMessage)` + `throw err`. CodeInputModal affiche l'erreur inline ET le toast. Redondance pour l'utilisateur.

**Fix:** Soit laisser le modal gérer l'affichage (pas de toast), soit laisser le hook gérer (pas de setError côté modal). Choisir une source unique de vérité pour les erreurs.

---

#### 12. [14-1] Tests — gradient-card non testé pour la valeur exacte

**Severity:** LOW  
**File:** `tests/unit/config/tailwind-design-tokens.test.ts:44-47`

**Issue:** Le test vérifie que `gradient-card` est défini et égal à une valeur spécifique. Si design-system-convergence change, le test pourrait échouer sans que ce soit un régression fonctionnelle. Couplage fort à la spec.

**Fix:** Documenter la source (design-system-convergence 3.2) dans le test ; ou assouplir l'assertion pour vérifier uniquement la présence et le format.

---

## Summary

| Severity | Count |
|----------|-------|
| CRITICAL | 2 |
| HIGH     | 3 |
| MEDIUM   | 4 |
| LOW      | 3 |

**Total:** 12 issues

---

## Recommended Actions

1. **CRITICAL:** Corriger le greeting Home (localUser.displayName) et CodeInputModal (setIsLoading dans try/finally).
2. **HIGH:** Ajouter gradient-card dans design-tokens.css ; clarifier isSupabaseAvailable ; améliorer extractCodeFromQR pour les QR invalides.
3. **MEDIUM:** Aligner useAuthContext ; documenter FAB vs Bottom menu ; gérer l’onglet Terminés ; étendre l’exclusion design-system.
4. **LOW:** Traiter en itération suivante.

---

## Fixes Applied (2026-02-13)

### CRITICAL
1. **Home greeting (AC1):** Utilisation de `localUser?.pseudo ?? user?.email?.split('@')[0] ?? 'Champion'` pour les utilisateurs anonymes.
2. **CodeInputModal isLoading:** Bloc `finally { setIsLoading(false); }` pour réinitialiser l'état dans tous les chemins.

### MEDIUM
3. **useAuth → useAuthContext:** Home utilise désormais `useAuthContext` pour cohérence.
4. **design-tokens.css:** Ajout de `--gradient-card` pour parité avec Tailwind.
5. **navigationHelpers:** Pattern `/^\/design-system/` pour exclure les sous-chemins.

### Tests
- `Home.refactored.test.tsx` : mock mis à jour vers `useAuthContext`.
- Tous les tests Home et navigationHelpers passent.

### Fixes supplémentaires (option 1 — problèmes restants)

**HIGH :**
- **isSupabaseAvailable** : Ajout de `isSupabaseAvailable()` dans `lib/supabase.ts`, utilisation dans `useHomeData` et `useJoinTournament`.
- **extractCodeFromQR** : Retourne `''` si aucun code valide (6–8 chars) ; Join ouvre le modal de saisie manuelle quand le QR est invalide.

**MEDIUM :**
- **Leagues — onglet Terminés** : Message « Les leagues terminées seront disponibles prochainement » quand le filtre est vide.
- **Story 10-3** : Note ajoutée sur la décision FAB vs Bottom menu (Story 14-16).

---

## Validation

- Les File Lists des stories correspondent au périmètre d’implémentation.
- Les tâches marquées [x] ont une implémentation correspondante.
- Les critères d’acceptation sont globalement satisfaits, avec les réserves ci-dessus.
